<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>그룹</title>
<script src = "https://code.jquery.com/jquery-3.6.1.min.js"></script>
<style type="text/css">
.group{
	display: flex;
	align-items: flex-start;
}
.GroupForm{
	margin: 20px;
}
.groupAlarm{
	margin: 20px;
}
</style>
<script type="text/javascript">

$(function(){
	$.ajax({
		type: "POST",
		url: "/group/alarmCount",
		success: function(alarmCount){
			$(".alarmCount").val(alarmCount);
		},
		error: function(){}
	})
	
	$(".GroupMemberSearch").keyup(function(event){
		if(event.key != 8){
			var memName = $(".GroupMemberSearch").val();
			
			$.ajax({
				type: "POST",
				url: "/group/GroupMemberSearch",
				data: {memName: memName},
				success: function(groupList){
					$(".NewGroupMember").html(null);
					groupList.forEach(function(group){
						const NewMemberRow = `
							<tr>
								<td onclick="MemberInsert('${group.memName}', '${group.friendNum}');" data-memNum = "${group.friendNum}">${group.memName}</td>
							</tr>`;
						$(".NewGroupMember").append(NewMemberRow);
					})
				},
				error: function(){
				}
			})
		}
	})
	
	
})

function MemberInsert(memName, memNum){
	let duplicate = false;
	
	$(".GroupMember td").each(function(){
		if($(this).data("memnum") === memNum){
			duplicate = true;
		}
	})
	
	if(!duplicate){
		const GroupMember = `
			<tr>
				<td data-memNum = "${memNum}">${memName}
				<input type = "hidden" name = "memName" value = "${memName}">
				<input type = "hidden" name = "memNum" value = "${memNum}"></td>
			</tr>
			`;
			
			$(".GroupMember").append(GroupMember);
	}else {
		alert("이미 등록되었습니다.");
	}
		
}

function groupYes(groupNum){
	$.ajax({
		type: "POST",
		url: "/group/groupEnter",
		data: {groupNum:groupNum},
		success: function(){
			alert("수락되었습니다.");
			window.location.reload();
		},
		error: function(){}
	})
}

function groupNo(groupNum){
	$.ajax({
		type: "POST",
		url: "/group/groupQuit",
		data: {groupNum:groupNum},
		success: function(){
			alert("거절되었습니다.");
			window.location.reload();
		},
		error: function(){}
	})
}

</script>
</head>
<body>

<h1>그룹</h1>

<div class = "group">
	<table style="margin:20px;" border="1">
	   <tr>
	       <th colspan="1">내 그룹</th><td>❤️💕🪼</td>
	   </tr>
	   <th:block th:each="myGroupList:${myGroupList}">
	   
	   <tr>
	       <td>그룹</td>
	       <td>[[${myGroupList.groupName}]]</td>
	   </tr>
	   <th:block th:each="groupMemberList:${groupMemberList}">
	   <tr>
	   		<td>참여자</td>
	   		<td>[[${groupMemberList.memName}]]</td>
	   </tr>
	   </th:block>
	   </th:block>
	</table>
	    
	<div class = "GroupForm">
		<form action = "/group/GroupForm" method = "POST">
		그룹명: <input type = "text" name = "groupName">
		<br><br>
		<table >
			<thead>
				<tr>
					<td>멤버 추가하기: <input type = "search" class = "GroupMemberSearch"></td>
				</tr>
			</thead>
			<tbody class = "NewGroupMember">
			</tbody>
		</table>
		<br>
		<table>
			<thead>
				<tr>
					<th>그룹원</th>
				</tr>
			</thead>
			<tbody class = "GroupMember">
			</tbody>
		</table>
		<input type = "submit" value = "그룹 등록">
		</form>
	</div>
	
	<div class = "groupAlarm">
		<block class = "alarmBox">알림함</block> <input type = "number" class = "alarmCount" value ="" readonly="readonly">
		<br><br>
		
		
		
			<th:block th:each="groupAlarmList:${groupAlarmList}">
			<table border = "1" width = "450px;">
				<th:block th:if="${groupAlarmList!=null}">
					<thead>
						<tr>
							<td colspan="3">그룹 이름</td>
						</tr>
					</thead>
				
				</th:block>
				<tbody>
					<tr>
						<td width="300px;">
							[[${groupAlarmList.groupName}]]에서 초대가 왔습니다.
						</td>
					
						<th>
							<button type = "button"
								th:attr="onclick=|groupYes('${groupAlarmList.groupNum}');|">수락
							</button>
						</th>
						<th>
							<button type = "button"
								th:attr="onclick=|groupNo('${groupAlarmList.groupNum}');|">거절
							</button>
						</th>
					</tr>
				</tbody>
			
		</table>
		</th:block>
	</div>
</div>

</body>
</html>